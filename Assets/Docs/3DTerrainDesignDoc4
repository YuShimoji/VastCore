# 命令: あなたは熟練したUnityのグラフィックスエンジニアです。以下の仕様に基づき、**「Marching Cubesアルゴリズムを用いたハイブリッド・ボクセル地形生成システム」**のC#スクリプトを作成してください。

# プロジェクトの目的: 従来の2Dハイトマップ地形に対し、3Dノイズによる洞窟生成と、SDF（Signed Distance Field）を用いたスタンプ合成を行い、**「穴の空いた地形」や「オーバーハング」**を実現すること。

# 技術要件（必須）:

環境: Unity 2022以降 / C#

最適化: Unity.Jobs System および Burst Compiler を使用し、メインスレッドをブロックしない並列処理でメッシュ生成を行うこと。

依存ライブラリ: Unity.Mathematics を使用すること。

# 実装すべき機能仕様:

1. Voxel Data Structure (Density Calculation) 各座標 (x,y,z) における密度（Density）を計算する関数 CalculateDensity(float3 pos) を実装してください。密度値が 0 以上なら地面、負なら空気とします。計算式は以下のロジックを組み合わせてください。

Base Terrain: 2Dハイトマップ（Mathf.PerlinNoise等で代用可）から基本の高さを取得。

baseDensity = pos.y - HeightMap(pos.x, pos.z)

3D Caves: 3D Perlin Noise（またはSimplex）を使用し、洞窟の「チューブ」を生成する。

caveDensity を計算し、Base Terrainから引き算（Subtract）する。

SDF Stamps: （今回は仮実装として）球体（Sphere SDF）の数式を使い、指定した座標に「空洞」または「岩」を追加・削除できるロジックを含める。

SmoothMin または SmoothMax 関数を使用し、地形とスタンプの結合部分が滑らかに溶け合う（Blend）ようにすること。

2. Marching Cubes Meshing

計算されたDensityデータを元に、メッシュ（Vertices, Triangles）を生成する。

法線（Normals）の計算: 隣接する密度データの勾配（Gradient）から滑らかな法線を計算すること（フラットシェーディングではない）。

Chunk System: 世界を無限に広げられるよう、指定サイズ（例: 16x16x16）ごとのチャンク生成スクリプトとして設計すること。

3. Texturing (Triplanar Shader)

UV展開が困難なため、生成されたメッシュに対して適用する**「Triplanar Mapping Shader（Shader GraphまたはHLSL）」**のコードも含めること。

垂直な面（壁）と水平な面（床）でテクスチャがブレンドされるようにすること。

# 出力してほしいもの:

VoxelDensity.cs: 密度計算ロジック（Job対応）。

MarchingCubesGenerator.cs: メッシュ生成のコアロジック（Job対応）。

ChunkManager.cs: プレイヤーの位置に合わせてチャンクを生成・破棄する管理クラス。

TriplanarSurface.shader: 地形用シェーダー。

# 特別な注意点:

コードはそのままコピペで動くように、必要な using 宣言を省略しないこと。

Marching Cubes のルックアップテーブル（EdgeTable, TriTable）はコードが長くなるため、簡略化した記述にするか、静的配列として定義する部分を明示すること。

この仕様書の意図とポイント
このプロンプトには、ユーザー様の懸念を解消するための以下の「仕掛け」が組み込まれています。

Job System & Burst 指定:

「マーチングキューブは重い」という問題を最初から解決するため、**「最適化（並列処理）が前提」**であることを強制しています。これがないと、AIは重いシングルスレッドのコードを書く傾向があります。

Density計算式の明記:

pos.y - HeightMap という式を指定することで、「既存のハイトマップの考え方」をベースにするよう誘導しています。これにより、完全に異質なボクセルシステムではなく、馴染みのある挙動になります。

Smooth Blendingの指定:

SDFスタンプやノイズ同士の結合部分がカクつかないよう、**「SmoothMin（滑らかな最小値）」**の使用を義務付けています。これが「溶接されたような自然な結合」の鍵です。

Triplanar Shaderの要求:

メッシュを作っても「テクスチャが貼れない（UVがない）」という問題に直面するのを防ぐため、最初から専用シェーダーを用意させています。

次のステップ（コードが出力されたら）
AIがコードを出力した後、ユーザー様が行うべき手順は以下の通りです。

プロジェクト設定: Unityで Burst と Mathematics パッケージをPackage Managerからインストールする。

スクリプト配置: 出力されたC#スクリプトを作成する。

マテリアル作成: 出力されたシェーダーでマテリアルを作り、岩や土のテクスチャをセットする。

実行: ChunkManager を空のGameObjectにアタッチして再生する。

これで、**「ハイトマップベースでありながら、洞窟があり、滑らかにスタンプ合成できる地形」**が目の前に生成されるはずです。まずはこの土台を動かし、その後に「SDFスタンプを数式から3Dテクスチャ読み込みに変更する」という拡張を行うのが最もスムーズです。